{% load static %} 

{% block css %}
  <link rel="stylesheet" href="{% static 'styles/map_marker.css' %}" />
  <link rel="stylesheet" href="{% static 'styles/partials/navbar.css' %}" />
  <link rel="stylesheet" href="{% static 'styles/partials/footer.css' %}" />
  <link rel="stylesheet" href="{% static 'styles/test_overlay.css'%}" />
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link href="https://fonts.googleapis.com/css2?family=Do+Hyeon&display=swap" rel="stylesheet"/>
{% endblock %} 

{% block navbar %} 
	{% include "partials/navbar.html" %}
{% endblock %} 

<body>
  <div id="map" style="width:100%;height:84%;"></div>

  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=8473586f2a4919e8cf90580a8334ebbc&libraries=services"></script>
  <script>
    var mapContainer = document.getElementById('map'), // ì§€ë„ë¥¼ í‘œì‹œí•  div 
      mapOption = { 
          center: new kakao.maps.LatLng(37.502, 127.026581), // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
          level: 12 // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
      };

    var map = new kakao.maps.Map(mapContainer, mapOption); // ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤

    var imageSrc = '../../static/images/test_marker.png', // ë§ˆì»¤ì´ë¯¸ì§€ì˜ ì£¼ì†Œì…ë‹ˆë‹¤    
        imageSize = new kakao.maps.Size(30, 30), // ë§ˆì»¤ì´ë¯¸ì§€ì˜ í¬ê¸°ì…ë‹ˆë‹¤
        imageOption = {offset: new kakao.maps.Point(12, 34)}; // ë§ˆì»¤ì´ë¯¸ì§€ì˜ ì˜µì…˜ì…ë‹ˆë‹¤. ë§ˆì»¤ì˜ ì¢Œí‘œì™€ ì¼ì¹˜ì‹œí‚¬ ì´ë¯¸ì§€ ì•ˆì—ì„œì˜ ì¢Œí‘œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
    
    // ë§ˆì»¤ì˜ ì´ë¯¸ì§€ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆëŠ” ë§ˆì»¤ì´ë¯¸ì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
    var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);

    // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ê°€ í‘œì‹œë  ìœ„ì¹˜ì…ë‹ˆë‹¤
    var newData = [];
    var imageInfo = {};

    $.ajax({
        url: "{% url 'posts:getApi' %}",
        dataType: "json",
        success: function (data) {
            // ajax ë¡œ ë°›ì•„ì˜¨ data ë¥¼ newData ë³€ìˆ˜ì— ì €ì¥ (ìŠ¤ì½”í”„ë°–ì—ì„œë„ ì“°ê¸° ìœ„í•´)
            newData = data;
        },

        error: function (request, status, error) {
            console.log('ì‹¤íŒ¨');
        },
        async: false
    });

    // console.log(newData);


    function addMarker(position) {
        var marker = new kakao.maps.Marker({
            map: map,
            position: position,
            image: markerImage
        });
        marker.setMap(map);

        //ë§ˆì»¤ í´ë¦­ ì‹œ ì˜¤ë²„ë ˆì´ ë‚˜íƒ€ë‚˜ë„ë¡í•˜ê¸°
        kakao.maps.event.addListener(marker, 'click', function(){
            // index
            var imageList = [];
            for(var i = 0; i < newData.length; i++) {
                if(position.La == newData[i].fields.lng && position.Ma == newData[i].fields.lat) {
                    var tempObj = {
                        index: newData[i].pk,
                        imageDir: "../../media/images/" + newData[i].fields.image.slice(7)
                    };
                    imageList.push(tempObj);
                }
            }
            console.log(imageList);

            // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ ì½˜í…ì¸  Dom ìœ¼ë¡œ êµ¬í˜„
            var content = document.createElement("div");
            content.className = 'overlay__container';

            var headContainer = document.createElement("div");
            headContainer.className = "box__header";
            content.appendChild(headContainer);

            var pin = document.createElement("span");
            pin.className = 'pin';
            pin.appendChild(document.createTextNode("ğŸ“"));
            headContainer.appendChild(pin);

            var close = document.createElement("span");
            close.className = 'close';
            close.appendChild(document.createTextNode("âœ–ï¸"));
            close.onclick = function() { testOverlay.setMap(null); };
            headContainer.appendChild(close);

            var imageContainer = document.createElement("div");
            imageContainer.className = 'image__container';
            content.appendChild(imageContainer);


            for(var i = 0; i < imageList.length; i++) {
                var img = document.createElement("img");
                var anchor = document.createElement("a");
                img.src = imageList[i].imageDir;
                anchor.setAttribute("href", `../${imageList[i].index}`);
                anchor.appendChild(img);
                imageContainer.appendChild(anchor);
            }

            //ë§ˆì»¤ìš© ì˜¤ë²„ë ˆì´ ë‚˜íƒ€ë‚´ê¸°
            var testOverlay = new kakao.maps.CustomOverlay({
                content: content,
                position: position
            });

            testOverlay.setMap(map);
        });
    }

    // positions ë°°ì—´ ìƒì„±
    var positions = [];
    for (var i = 0; i < newData.length; i++) {
        positions.push(new kakao.maps.LatLng(newData[i].fields.lat, newData[i].fields.lng));
    }
    // console.log(positions);
    

    // ë§ˆì»¤ ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜ show ìƒì„±
    function show() {
        for(var i = 0; i < positions.length; i++) {
            addMarker(positions[i]);
        }
    }

    show();

  </script>
</body>

{% block footer %} 
	{% include "partials/footer.html" %}
{% endblock %} 
